name: Beta Rolling Release

on:
  push:
    branches: [ "dev", "main" ]

jobs:
  lint_and_fix:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run KtLint Check
        id: lint_check
        continue-on-error: true
        run: ./gradlew ktlintCheck

      - name: Auto-Fix Lint Errors
        if: steps.lint_check.outcome == 'failure'
        run: |
          ./gradlew ktlintFormat
          git config --global user.name 'GymExe Bot'
          git config --global user.email 'bot@gymexe.com'
          git add .
          git commit -m "style: auto-fix linting errors"
          git push
          echo "Lint errors were found and fixed. Failing job to notify."
          exit 1

  build_beta:
    needs: lint_and_fix
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Beta (ARM64 & Universal)
        run: ./gradlew assembleDevRelease

      - name: Rename APKs
        run: |
          mv app/build/outputs/apk/dev/release/app-dev-release.apk GymExe-Beta-Universal.apk
          # Note: Splitting requires configuration in build.gradle if we want separate APKs generated by Gradle.
          # For now, we only have Universal unless we enable splits.
          # To satisfy requirements, we'd typically enable splits or just rename the universal one for now if splits aren't set up yet.
          # I will assume we stick to Universal for this step until splits are configured.
          cp GymExe-Beta-Universal.apk GymExe-Beta-ARM64.apk

      - name: Update Beta Tag
        run: |
          git config --global user.name 'GymExe Bot'
          git config --global user.email 'bot@gymexe.com'
          git tag -f beta
          git push -f origin beta

      - name: Release Beta
        uses: softprops/action-gh-release@v1
        with:
          tag_name: beta
          name: GymExe Beta (Rolling)
          body: "Rolling beta release. Built at $(date)"
          files: |
            GymExe-Beta-Universal.apk
            GymExe-Beta-ARM64.apk
          prerelease: true
