name: Build & Release

on:
  pull_request:
    branches: [ "dev" ] # Beta Build on PR commits
  push:
    tags: [ "v*" ]      # Stable Release on tags
  workflow_dispatch:    # Manual Beta Trigger

jobs:
  quality_check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run KtLint Check
        id: lint_check
        continue-on-error: true
        run: ./gradlew ktlintCheck

      # Auto-fix lint errors only on PRs
      - name: Auto-Fix Lint Errors
        if: steps.lint_check.outcome == 'failure' && github.event_name == 'pull_request'
        run: |
          ./gradlew ktlintFormat
          git config --global user.name 'GymExe Bot'
          git config --global user.email 'bot@gymexe.com'
          git fetch origin ${{ github.head_ref }}
          git checkout ${{ github.head_ref }}
          git add .
          git commit -m "style: auto-fix linting errors"
          git push origin ${{ github.head_ref }}
          echo "Lint errors were found and fixed. Failing job to notify."
          exit 1

      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest

  build_beta:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    needs: quality_check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for calculating commit count

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Calculate Version Name
        id: version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR Build: v{Tag}-beta-PR{Number}.{CommitCount}
            PR_NUM="${{ github.event.number }}"
            # Calculate commits in PR (HEAD vs origin/dev)
            git fetch origin dev
            COMMIT_COUNT=$(git rev-list --count HEAD ^origin/dev)
            VERSION_NAME="${LATEST_TAG}-beta-PR${PR_NUM}.${COMMIT_COUNT}"
          else
            # Manual Build: v{Tag}-beta-r{RunId}
            VERSION_NAME="${LATEST_TAG}-beta-r${{ github.run_number }}"
          fi

          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "Calculated Version: ${VERSION_NAME}"

      - name: Build Beta (Universal)
        run: ./gradlew assembleDevRelease
        env:
          VERSION_NAME: ${{ env.VERSION_NAME }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GymExe-Beta-${{ env.VERSION_NAME }}
          path: app/build/outputs/apk/dev/release/app-dev-release.apk

  release_stable:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: quality_check
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Set Version Name from Tag
        run: |
          # Strip 'refs/tags/v' to get '1.0.0'
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "VERSION_NAME=${TAG_NAME}" >> $GITHUB_ENV

      - name: Build Stable
        run: ./gradlew assembleProdRelease
        env:
          VERSION_NAME: ${{ env.VERSION_NAME }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/prod/release/app-prod-release.apk
          generate_release_notes: true
