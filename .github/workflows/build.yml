name: Build & Release

on:
  push:
    branches: [ "dev" ] # Beta builds on push to dev
    tags: [ "v*" ]      # Stable builds on version tags
  workflow_dispatch:    # Manual trigger option

jobs:
  lint_and_test:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run KtLint Check
        id: lint_check
        continue-on-error: true
        run: ./gradlew ktlintCheck

      # Only auto-fix on dev branch pushes, not tags
      - name: Auto-Fix Lint Errors
        if: steps.lint_check.outcome == 'failure' && github.ref_type == 'branch'
        run: |
          ./gradlew ktlintFormat
          git config --global user.name 'GymExe Bot'
          git config --global user.email 'bot@gymexe.com'
          git add .
          git commit -m "style: auto-fix linting errors"
          git push
          echo "Lint errors were found and fixed. Failing job to notify."
          exit 1

  build_and_release:
    needs: lint_and_test
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # --- BETA / DEV FLOW ---
      - name: Build Beta (Dev Branch)
        if: github.ref == 'refs/heads/dev'
        run: ./gradlew assembleDevRelease

      - name: Prepare Beta Artifacts
        if: github.ref == 'refs/heads/dev'
        run: |
          mv app/build/outputs/apk/dev/release/app-dev-release.apk GymExe-Beta-Universal.apk
          cp GymExe-Beta-Universal.apk GymExe-Beta-ARM64.apk

      - name: Update Beta Tag
        if: github.ref == 'refs/heads/dev'
        run: |
          git config --global user.name 'GymExe Bot'
          git config --global user.email 'bot@gymexe.com'
          git tag -f beta
          git push -f origin beta

      - name: Release Beta (Rolling)
        if: github.ref == 'refs/heads/dev'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: beta
          name: GymExe Beta (Rolling)
          body: "Rolling beta release. Built at $(date)"
          files: |
            GymExe-Beta-Universal.apk
            GymExe-Beta-ARM64.apk
          prerelease: true

      # --- STABLE / TAG FLOW ---
      - name: Build Stable
        if: startsWith(github.ref, 'refs/tags/v')
        run: ./gradlew assembleProdRelease

      - name: Release Stable
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/prod/release/app-prod-release.apk
          generate_release_notes: true
