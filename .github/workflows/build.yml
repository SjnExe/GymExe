name: Build & Release

on:
  pull_request:
    branches: [ "dev" ] # Lint & Beta Build on PR commits
  push:
    tags: [ "v*" ]      # Stable Release on tags
  workflow_dispatch:    # Manual Beta Trigger

jobs:
  lint_and_test:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools build-tools;35.0.0 platforms;android-35'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run KtLint Check
        id: lint_check
        continue-on-error: true
        run: ./gradlew ktlintCheck

      # Auto-fix lint errors only on PRs (commits back to the PR branch)
      - name: Auto-Fix Lint Errors
        if: steps.lint_check.outcome == 'failure' && github.event_name == 'pull_request'
        run: |
          ./gradlew ktlintFormat
          git config --global user.name 'GymExe Bot'
          git config --global user.email 'bot@gymexe.com'
          # Fetch the PR branch reference to commit back to it
          git fetch origin ${{ github.head_ref }}
          git checkout ${{ github.head_ref }}
          git add .
          git commit -m "style: auto-fix linting errors"
          git push origin ${{ github.head_ref }}
          echo "Lint errors were found and fixed. Failing job to notify."
          exit 1

      - name: Run Unit Tests
        run: ./gradlew test

  build_and_release:
    needs: lint_and_test
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools build-tools;35.0.0 platforms;android-35'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # --- BETA / PR / MANUAL FLOW ---
      # Runs on Pull Requests OR Manual Dispatch
      - name: Build Beta (ARM64 & Universal)
        if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        run: ./gradlew assembleDevRelease

      - name: Prepare Beta Artifacts
        if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        run: |
          mv app/build/outputs/apk/dev/release/app-dev-release.apk GymExe-Beta-Universal.apk
          cp GymExe-Beta-Universal.apk GymExe-Beta-ARM64.apk

      - name: Update Beta Tag (Manual Only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config --global user.name 'GymExe Bot'
          git config --global user.email 'bot@gymexe.com'
          git tag -f beta
          git push -f origin beta

      - name: Release Beta (Rolling - Manual Only)
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: beta
          name: GymExe Beta (Rolling)
          body: "Rolling beta release. Built at $(date)"
          files: |
            GymExe-Beta-Universal.apk
            GymExe-Beta-ARM64.apk
          prerelease: true

      # For PRs, we just upload artifacts to the Action Run (no GitHub Release)
      - name: Upload PR Artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: beta-apks
          path: |
            GymExe-Beta-Universal.apk
            GymExe-Beta-ARM64.apk

      # --- STABLE / TAG FLOW ---
      - name: Build Stable
        if: startsWith(github.ref, 'refs/tags/v')
        run: ./gradlew assembleProdRelease

      - name: Release Stable
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/prod/release/app-prod-release.apk
          generate_release_notes: true
